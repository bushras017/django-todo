name: Deploy Infrastructure

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  ZONE: us-central1-a

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Auth to GCP
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Extract Service Account Email
      id: sa-email
      run: |
        SA_EMAIL=$(echo '${{ secrets.GCP_SA_KEY }}' | jq -r '.client_email')
        echo "SA_EMAIL=$SA_EMAIL" >> $GITHUB_ENV

    - name: Setup Additional IAM Permissions
      run: |
        gcloud projects add-iam-policy-binding ${{ secrets.GCP_PROJECT_ID }} \
          --member="serviceAccount:${{ env.SA_EMAIL }}" \
          --role="roles/storage.admin"

        gcloud projects add-iam-policy-binding ${{ secrets.GCP_PROJECT_ID }} \
          --member="serviceAccount:${{ env.SA_EMAIL }}" \
          --role="roles/bigquery.dataEditor"
        
        gcloud projects add-iam-policy-binding ${{ secrets.GCP_PROJECT_ID }} \
          --member="serviceAccount:${{ env.SA_EMAIL }}" \
          --role="roles/logging.configWriter"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Create terraform.tfvars
      run: |
        cat > terraform/terraform.tfvars << EOF
        project_id = "${{ secrets.GCP_PROJECT_ID }}"
        region = "${{ env.REGION }}"
        zone = "${{ env.ZONE }}"
        db_password = "${{ secrets.DB_PASSWORD }}"
        notification_email = "${{ secrets.NOTIFICATION_EMAIL }}"
        notification_email_password = "${{ secrets.EMAIL_APP_PASSWORD }}"
        alert_email_recipients = ${{ secrets.ALERT_EMAILS }}
        service_account_email = "${{ env.SA_EMAIL }}"
        EOF

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Clean and Import Resources
      working-directory: ./terraform
      run: |
        # Remove existing state
        terraform state rm google_compute_network.vpc || true
        terraform state rm google_compute_subnetwork.subnet || true
        terraform state rm google_compute_firewall.allow_monitoring || true
        terraform state rm google_compute_firewall.allow_django || true
        terraform state rm google_compute_firewall.allow_internal || true
        terraform state rm google_compute_instance.db_server || true
        terraform state rm google_compute_instance.web_server || true
        terraform state rm google_bigquery_dataset.security_logs || true
        terraform state rm google_pubsub_topic.prometheus_alerts || true
        terraform state rm google_storage_bucket.function_bucket || true
        terraform state rm google_cloudfunctions_function.alert_handler || true
        
        # Import resources
        echo "Importing VPC..."
        terraform import google_compute_network.vpc \
          "projects/${{ secrets.GCP_PROJECT_ID }}/global/networks/devsecops-vpc" || true
        
        echo "Importing subnet..."
        terraform import google_compute_subnetwork.subnet \
          "projects/${{ secrets.GCP_PROJECT_ID }}/regions/${{ env.REGION }}/subnetworks/devsecops-subnet" || true
        
        echo "Importing firewall rules..."
        terraform import google_compute_firewall.allow_monitoring \
          "projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-monitoring" || true
        
        terraform import google_compute_firewall.allow_django \
          "projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-django" || true
        
        terraform import google_compute_firewall.allow_internal \
          "projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/allow-internal" || true
        
        terraform import google_compute_firewall.blocked_ips \
          "projects/${{ secrets.GCP_PROJECT_ID }}/global/firewalls/blocked-ips" || true
        
        echo "Importing compute instances..."
        terraform import google_compute_instance.db_server \
          "projects/${{ secrets.GCP_PROJECT_ID }}/zones/${{ env.ZONE }}/instances/db-server" || true
        
        terraform import google_compute_instance.web_server \
          "projects/${{ secrets.GCP_PROJECT_ID }}/zones/${{ env.ZONE }}/instances/web-server" || true
        
        echo "Importing BigQuery dataset..."
        terraform import google_bigquery_dataset.security_logs \
          "${{ secrets.GCP_PROJECT_ID }}:security_logs" || true
        
        echo "Importing Pub/Sub topic..."
        terraform import google_pubsub_topic.prometheus_alerts \
          "projects/${{ secrets.GCP_PROJECT_ID }}/topics/prometheus-alerts" || true
        
        echo "Importing storage bucket..."
        terraform import google_storage_bucket.function_bucket \
          "${{ secrets.GCP_PROJECT_ID }}-functions" || true
        
        echo "Importing cloud function..."
        terraform import google_cloudfunctions_function.alert_handler \
          "projects/${{ secrets.GCP_PROJECT_ID }}/locations/${{ env.REGION }}/functions/alert-handler" || true
        
        # Show the current state
        echo "Current Terraform State:"
        terraform state list

    - name: Terraform Plan
      if: github.event_name == 'pull_request'
      working-directory: ./terraform
      run: terraform plan

    - name: Prepare Cloud Function
      run: |
        if [ -d "cloud_function" ]; then
          cd cloud_function
          zip -r ../terraform/function.zip ./*
        else
          echo "Cloud function directory not found. Creating empty function.zip"
          touch empty.txt
          zip terraform/function.zip empty.txt
          rm empty.txt
        fi

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        cd terraform
        # First refresh the state
        terraform apply -refresh-only -auto-approve || true
        
        # Then apply changes
        terraform apply -auto-approve


